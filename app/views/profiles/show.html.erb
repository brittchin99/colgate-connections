<head>
  <%= stylesheet_link_tag 'application', media: 'all' %>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://raw.githack.com/SortableJS/Sortable/master/Sortable.js"></script>
</head>
<div class="main">
  
  <% if !@profile.pending_friend_request?(current_account.profile) and !!current_account.profile.pending_friend_request?(@profile) %>
    <div class="alert alert-secondary" role="alert">
      <%= @profile.first_name %> would like to connect with you.
      <%= link_to "Accept", connections_path(:friend_id => @profile), :method => :post, :class => "btn btn-primary spacer" %>
      <%= link_to "Delete", friend_request_path(:friend_id => @profile), :method => :delete, :class => "btn btn-light" %>
    </div>
  <% end %>
  
  <% if flash[:success] %>
    <div class="alert alert-success notice alert-dismissible alert-notif" role="alert">
      <%= "#{flash[:success]}" %>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    </div>
  <% end %>
  <% if flash[:notice] %>
    <div class="alert alert-primary notice alert-dismissible alert-notif" role="alert">
      <%= "#{flash[:notice]}" %>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div class="alert alert-warning notice alert-dismissible alert-notif" role="alert">
      <%= "#{flash[:alert]}" %>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    </div>
  <% end %>
  
  <% if current_account.profile == @profile %>
    <%= link_to "", setting_path(:id => current_account.id), :class => "btn fas fa-cog setting" %>
  <% end %>
  <div class="profile-container">
    
      <!--check logged in to the right user -->
      <% if current_account.profile == @profile %>
        <%= link_to "Update Profile", edit_profile_path(@profile), :class => "btn btn-primary update-button" %>
      <% end %>
      <div class="profile-basic">
            <% if !@profile.blocking(current_account.profile) && !current_account.profile.blocking(@profile) && @profile.avatar.attached? %>
              <div class="center">
                <img class="profile-image-circle" src="<%= (url_for(@profile.avatar)) %>">
              </div>
            <% else %>
              <div class="center">
                <%= image_tag("avatar.jpeg", class: "profile-image-circle", alt:"photo") %>
              </div>
            <% end %>
            <div class="profile-text">
                 <h4><%= "#{@profile.first_name} #{@profile.last_name}" %>
                 
                 <% if (current_account.profile == @profile && current_account.profile.setting.dating) || (current_account.profile != @profile and current_account.profile.is_a_match(@profile)) %>
                   <%= image_tag("heart.png", class: "heart", alt:"heart") %> 
                 <% end %>
                 </h4>
                 <% if current_account.profile.should_show("Pronouns", @profile)%>
                   <p> <%= "#{@profile.pronouns}"%></p>
                   <% end %>
                  <!--check logged in to the right user -->
                  <% if current_account.profile.blocking(@profile) %>
                  
                    <%= link_to "Unblock #{@profile.first_name}", blockage_path(:blockee_id => @profile), :method => :delete, :class => "btn btn-primary" %>
                
                  <% end %>
                  
                  <% if !@profile.blocking(current_account.profile) && !current_account.profile.blocking(@profile) %>
                    <div>
                      <% if current_account.profile!=@profile %>
                        <% if !current_account.profile.connected_to(@profile) %>
                          <% if @profile.pending_friend_request?(current_account.profile) %>
                            <%= link_to "Unsend Friend Request", friend_request_path(:friend_id => @profile), :method => :delete, :class => "btn btn-secondary" %>
                          <% elsif !current_account.profile.pending_friend_request?(@profile) %>
                            <%= link_to "Send Friend Request", friend_requests_path(:friend_id => @profile), :method => :post, :class => "btn btn-primary" %>
                          <% end %>
    
                        <% elsif current_account.profile.connected_to(@profile) %>
                          
                   
                        <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Connected
                        </button>
                          <div class="dropdown-menu dropdown-menu-right">
                            <%= link_to "Disconnect", connection_path(:friend_id => @profile), :method => :delete, :class => "dropdown-item" %>
                        </div>
                  
                          <%= link_to "Message #{@profile.first_name}", conversations_path(:sender_id => current_account, :receiver_id => @profile), :method => :post, :class => "btn btn-primary" %>
                        <% end %>
                      <% end %>
                      
                      <% if current_account.profile!=@profile %>
                      <div class="btn-group">
                        <button type="button" class="btn options" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          <h1 class="options-text">&middot;&middot;&middot;</h1>
                        </button>
                          <div class="dropdown-menu dropdown-menu-right">
                            
                              <%= link_to "Block #{@profile.first_name}", blockages_path(:blockee_id => @profile), :method => :post, :class => "dropdown-item" %>
                           
                        </div>
                      </div>
                    </div>
                   
                    <%end%>
                    
                    <% if @profile.status && current_account.profile.should_show("Status", @profile)%>
                        <div class="pad"><%= "#{@profile.status}"%></div>
                    <% end %>
                    <% if current_account.profile==@profile %>
                      <% if !@profile.status %>
                        <button onclick="toggle()" class="add-button" id="profile-status">Add a status</button>                      
                      <% end %>
                    <% end %>
                    <!--connected & message button -->
                    
                  <% end %>

                  <br/>
            </div>
      </div> 

      <% if !@profile.blocking(current_account.profile) && !current_account.profile.blocking(@profile) %>
        <div>
          <table class="profile-info">
                <tr>
                  <th><%= "Class of #{@profile.class_year}" %></th>
                </tr>
                <tr>
                  <th>Major(s):</th>
                  <td> 
                    <%= Profile.toList(@profile.majors).join(", ")%>
                  </td>
                </tr>
                <tr>
                  <th>Minor(s):</th>
                  <td> 
                    <%= Profile.toList(@profile.minors).join(", ")%>
                  </td>
                </tr>
                <% if current_account.profile.should_show("Interests", @profile) %>
                  <tr>
                    <th>Interest(s):</th>
                    <td>
                      <%= Profile.toList(@profile.interests).join(", ")%>
                    </td>
                  </tr>
                <% end %>
          </table>
          
  
        <% if current_account.profile ==@profile && @profile.photos.attachments.length < 13 %>
          <button onclick="f()" class="add-button">Upload up to 13 photos!</button>
        <% end %>
        
        <% if current_account.profile.should_show("Photos", @profile) %>
            <div class="photos" id="items">
            <% if @profile.photos.attached? %>
                <% @profile.photos.each do |photo| %>
                  <img class="profile-image-square" src="<%= (url_for(photo)) %>">
                <%end %>
            <% else %>
              <br/>
              <h5 class="center pad">No photos yet.</h5>
            <% end %>
            <% if current_account.profile ==@profile && @profile.photos.attachments.length < 13 %>
            <div class="profile-image-square">
              <div class="add-form">
               <%= simple_form_for @profile, :url => url_for(:action => 'update', :controller => 'profiles'), :method => 'patch' do |f| %>
                <%= f.file_field :photos, id: "f-field", required: true %>
                <%= f.button :submit %>
               <% end %>
               </div>
              </div>
            <% end %>

            </div>
        <% else %>
          <br/>
          <h5 class="center pad"><p class="fas fa-lock"/> This user's photos are private</h5>
        <% end %>
            
       </div>
      <% elsif current_account.profile.blocking(@profile) %>
        <div class="pad">User is blocked.</div>
      <% else %>
        <div class="pad">User unavailable</div>
      <% end %>
</div>
</div>

    
    
<script>
var el = document.getElementById("items");
// from sortableJS
var sortable = Sortable.create(el, {
  group: "localStorage-example",
  store: {
    get: function (sortable) {
      var order = localStorage.getItem(sortable.options.group.name);
      return order ? order.split("|") : [];
    },

    set: function (sortable) {
      var order = sortable.toArray();
      localStorage.setItem(sortable.options.group.name, order.join("|"));
    },
  },
});
</script>